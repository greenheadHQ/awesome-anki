<div id="front" class="linkRender"><pre>{{cloze:Text}}</pre></div>

<script>
  var getResources = [
    getCSS(
      "_katex.css",
      "https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    ),
    getCSS(
      "_highlights.css",
      "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/tokyo-night-dark.min.css"
    ),
    getScript(
      "_highlight.js",
      "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"
    ),
    getScript(
      "_katex.min.js",
      "https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
    ),
    getScript(
      "_auto-render.js",
      "https://cdn.jsdelivr.net/gh/Jwrede/Anki-KaTeX-Markdown/auto-render-cdn.js"
    ),
    getScript(
      "_markdown-it.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.0.4/markdown-it.min.js"
    ),
    getScript(
      "_markdown-it-mark.js",
      "https://cdn.jsdelivr.net/gh/Jwrede/Anki-KaTeX-Markdown/_markdown-it-mark.js"
    ),
    getScript(
      "_markdown-it-container.min.js",
      "https://cdn.jsdelivr.net/npm/markdown-it-container@3.0.0/dist/markdown-it-container.min.js"
    ),
  ];

  Promise.all(getResources)
    .then(() =>
      getScript(
        "_mhchem.js",
        "https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/mhchem.min.js"
      )
    )
    .then(render)
    .catch(show);

  function defineEnhancedClozeAddEventListener() {
    if (typeof window.enhancedClozeEventListener !== "undefined") {
      for (const listener of window.enhancedClozeEventListener) {
        const [type, handler] = listener;
        document.removeEventListener(type, handler);
      }
    }
    window.enhancedClozeEventListener = [];

    window.enhancedClozeAddEventListener = function (type, handler) {
      document.addEventListener(type, handler);
      window.enhancedClozeEventListener.push([type, handler]);
    };
  }

  function getScript(path, altURL) {
    return new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.onload = resolve;
      script.onerror = function () {
        const script_online = document.createElement("script");
        script_online.onload = resolve;
        script_online.onerror = reject;
        script_online.src = altURL;

        document.querySelector(`script[src="${path}"]`)?.remove();
        document.head.appendChild(script_online);
      };
      script.src = path;

      document.querySelector(`script[src="${path}"]`)?.remove();
      document.head.appendChild(script);
    });
  }

  function getCSS(path, altURL) {
    return new Promise((resolve, reject) => {
      const css = document.createElement("link");
      css.setAttribute("rel", "stylesheet");
      css.type = "text/css";
      css.onload = resolve;
      css.onerror = function () {
        const css_online = document.createElement("link");
        css_online.setAttribute("rel", "stylesheet");
        css_online.type = "text/css";
        css_online.onload = resolve;
        css_online.onerror = reject;
        css_online.href = altURL;

        document.querySelector(`link[href="${path}"]`)?.remove();
        document.head.appendChild(css_online);
      };
      css.href = path;

      document.querySelector(`link[href="${path}"]`)?.remove();
      document.head.appendChild(css);
    });
  }

  function getMarkdownRenderer() {
    const md = new markdownit({
      typographer: true,
      html: true,
      highlight: function (str, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try {
            return hljs.highlight(str, { language: lang }).value;
          } catch (__) {}
        }
        return "";
      },
    }).use(markdownItMark);

    const calloutTypes = ["tip", "warning", "error", "note", "link"];

    const getCalloutImoji = (type) => {
      switch (type) {
        case "tip":
          return "ğŸ’¡";
        case "warning":
          return "ğŸš§";
        case "error":
          return "ğŸš¨";
        case "note":
          return "ğŸ“";
        case "link":
          return "ğŸ”—";
        default:
          return "";
      }
    };

    calloutTypes.forEach((type) => {
      md.use(window.markdownitContainer, type, {
        validate: function (params) {
          return params.trim().match(new RegExp(`^${type}(\\s+(.*))?$`));
        },
        render: function (tokens, idx) {
          const m = tokens[idx].info
            .trim()
            .match(new RegExp(`^${type}(\\s+(.*))?$`));
          if (tokens[idx].nesting === 1) {
            const title =
              m && m[2]
                ? `<strong>${getCalloutImoji(type)} ${md.utils.escapeHtml(
                    m[2]
                  )}</strong>`
                : "";
            return `<div class="callout ${type}">${title}`;
          } else {
            return "</div>\n";
          }
        },
      });
    });

    // Toggle ì»¨í…Œì´ë„ˆ ì¶”ê°€ (íƒ€ì…ë³„ ë°°ê²½ìƒ‰ ì§€ì›: tip, warning, error, note)
    md.use(window.markdownitContainer, "toggle", {
      validate: function (params) {
        return params.trim().match(/^toggle(\s+(.*))?$/);
      },
      render: function (tokens, idx) {
        const m = tokens[idx].info.trim().match(/^toggle(\s+(.*))?$/);
        if (tokens[idx].nesting === 1) {
          // íƒ€ì…ê³¼ ì œëª© ë¶„ë¦¬
          const restText = m && m[2] ? m[2].trim() : "";
          const toggleTypes = ["tip", "warning", "error", "note", "todo"];
          let toggleType = "";
          let title = "ì •ë³´";

          if (restText) {
            const firstWord = restText.split(/\s+/)[0];
            if (toggleTypes.includes(firstWord)) {
              // ì²« ë‹¨ì–´ê°€ íƒ€ì…ì¸ ê²½ìš°
              toggleType = firstWord;
              title = restText.substring(firstWord.length).trim() || "ì •ë³´";
            } else {
              // íƒ€ì…ì´ ì—†ëŠ” ê²½ìš°, ì „ì²´ê°€ ì œëª©
              title = restText;
            }
          }

          const typeClass = toggleType ? ` ${toggleType}` : "";
          title = md.renderInline(title);

          return `<div class="toggle${typeClass}">
            <div class="toggle-header">
              <span class="toggle-arrow"></span>
              <span class="toggle-title">${title}</span>
            </div>
            <div class="toggle-content">`;
        } else {
          return "</div></div>\n";
        }
      },
    });

    return md;
  }

  function render() {
    defineEnhancedClozeAddEventListener();
    renderMath("front");
    markdown("front");
    initializeToggles();
    show();

    window.enhancedClozeAddEventListener("keydown", handleKeydown);

    const clozeCards = document.getElementsByClassName("cloze");

    for (let i = 0; i < clozeCards.length; i++) {
      clozeCards[i].style.cursor = "pointer";
      clozeCards[i].style.backgroundColor = "#85B0FD";

      // [â€¦] for ordinary cloze , [...] for cloze in table element
      if (clozeCards[i].textContent === "[â€¦]" || clozeCards[i].textContent === "[...]") {
        clozeCards[i].textContent = "[___]";
      }

      clozeCards[i].addEventListener("click", callback);
      clozeCards[i].addEventListener("touchend", callback);
    }

    const inactiveClozeCards =
      document.getElementsByClassName("cloze-inactive");
    for (let inactiveClozeCard of inactiveClozeCards) {
      inactiveClozeCard.style.boxShadow = "inset 0 -2px 0 #FA96AF";
    }
  }

  /*
   * ğŸ¯ Toggle ì´ˆê¸°í™” í•¨ìˆ˜
   *
   * ëª©ì : ëª¨ë“  Toggle í—¤ë”ì— í´ë¦­/í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
   * ë™ì‘: í´ë¦­ ë˜ëŠ” í„°ì¹˜ ì‹œ toggle-active í´ë˜ìŠ¤ í† ê¸€í•˜ì—¬ í¼ì¹¨/ì ‘í˜ ìƒíƒœ ë³€ê²½
   *
   * ëª¨ë°”ì¼ í™˜ê²½(iOS/iPadOS) ì§€ì›:
   * - touchend ì´ë²¤íŠ¸ë¡œ í„°ì¹˜ ë””ë°”ì´ìŠ¤ì—ì„œ ì •ìƒ ì‘ë™
   * - preventDefault()ë¡œ ê¸°ë³¸ ë™ì‘ ë°©ì§€ ë° :hover ìƒíƒœ ì œê±°
   * - ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
   *
   * PC í™˜ê²½ ê°œì„ :
   * - í´ë¦­ í›„ blur()ë¡œ focus ì œê±°í•˜ì—¬ hover ìƒíƒœ ìœ ì§€ ë°©ì§€
   */
  function initializeToggles() {
    const toggleHeaders = document.querySelectorAll(".toggle-header");

    toggleHeaders.forEach((header) => {
      let lastToggleTime = 0;

      const toggleHandler = function(e) {
        // í„°ì¹˜ ì´ë²¤íŠ¸ì—ì„œ ê¸°ë³¸ ë™ì‘ ë°©ì§€ (iOS :hover ë¬¸ì œ í•´ê²°)
        if (e.type === 'touchend') {
          e.preventDefault();
        }

        // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€: 300ms ì´ë‚´ì˜ ì—°ì† ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
        const now = Date.now();
        if (now - lastToggleTime < 300) {
          return;
        }
        lastToggleTime = now;

        const toggleContainer = this.parentElement;
        toggleContainer.classList.toggle("toggle-active");

        // PCì—ì„œ í´ë¦­ í›„ focus ì œê±°í•˜ì—¬ hover ìƒíƒœ ìœ ì§€ ë°©ì§€
        this.blur();
      };

      // PC í™˜ê²½: click ì´ë²¤íŠ¸
      header.addEventListener("click", toggleHandler);

      // ëª¨ë°”ì¼ í™˜ê²½(iOS/iPadOS): touchend ì´ë²¤íŠ¸
      // passive: falseë¥¼ ì§€ì •í•˜ì—¬ preventDefault()ê°€ ë™ì‘í•˜ë„ë¡ í•¨
      header.addEventListener("touchend", toggleHandler, { passive: false });
    });
  }

  function renderLink() {
    document.querySelectorAll(".cloze").forEach((element) => {
      // You can rename "linkRender" on this line, but leave the "." in front
      element.innerHTML = element.innerHTML.replace(
        /\[((?:[^\[]|\\\[)*)\|nid(\d{13})\]/g,
        (match, title, nid) => {
          title = title.replace(/\\\[/g, "[");
          let link;
          if (
            document.documentElement.classList.contains("iphone") ||
            document.documentElement.classList.contains("ipad")
          ) {
            link = `anki://x-callback-url/search?query=nid%3a${nid}`;
          } else {
             link = `javascript:pycmd(\`AnkiNoteLinker-openNoteInPreviewer\`+\`${nid}\`)`
          }

          return disableLinks
            ? `${title}`
            : `<a href='${link}' class='noteLink' oncontextmenu="event.preventDefault();pycmd(\`AnkiNoteLinker-openNoteInNewEditor\`+\`${nid}\`)">${title}</a>`;
        }
      );
    });
  };

  /*
   * ğŸ® cloze í´ë¦­/í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜ (ë§í¬ ë³´í˜¸ ê°œì„ )
   * 
   * ìƒˆë¡œìš´ ì ‘ê·¼ë²•: 
   * - ëª¨ë“  HTML íƒœê·¸ë¥¼ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œí•˜ë˜, ë§í¬ëŠ” ë³´í˜¸
   * - ë‹¨ìˆœí•˜ê³  í™•ì‹¤í•œ ì²˜ë¦¬
   */
  function callback(e) {
    console.log("========= ê°œì„ ëœ Callback í•¨ìˆ˜ ì‹œì‘ =========");
    
    // A íƒœê·¸ í´ë¦­ ì‹œ ë§í¬ ë™ì‘ì„ ìš°ì„ ì‹œí•˜ê³  cloze ë™ì‘ ì¤‘ë‹¨
    if (e.target.nodeName === "A") {
      console.log("A íƒœê·¸ í´ë¦­, ì½œë°± ì¢…ë£Œ");
      return;
    }
    
    console.log("í´ë¦­ëœ ìš”ì†Œ:", this);
    console.log("data-cloze:", this.dataset.cloze);
    
    const ordinal = this.dataset.ordinal;

    /*
     * ğŸ¯ cloze ìƒíƒœ ì „í™˜ ì²˜ë¦¬
     */
    if (ordinal !== "0") {
      /*
       * ğŸ“– cloze í¼ì¹˜ê¸°: HTML ì†ì„± ë³´í˜¸í•˜ë©° í…ìŠ¤íŠ¸ í‘œì‹œ
       */
      console.log("cloze í¼ì¹˜ê¸° - ë§í¬ ë³´í˜¸ ì²˜ë¦¬");
      
      // í˜„ì¬ ordinal ê°’ì„ ì„ì‹œ ì €ì¥ (ë‚˜ì¤‘ì— ì ‘ì„ ë•Œ ì‚¬ìš©)
      this.dataset.tempOrdinal = this.dataset.ordinal;
      this.dataset.ordinal = "0";  // í¼ì³ì§„ ìƒíƒœë¡œ ë³€ê²½
      
      // hintê°€ ì—†ì„ ë•Œë§Œ ìµœì´ˆ í•œ ë²ˆ ì €ì¥ (ì ‘íŒ ìƒíƒœì˜ HTML ë³´ì¡´)
      if (!this.dataset.hint) {
        this.dataset.hint = this.textContent === "[___]" ? "false" : this.innerHTML;
      }
      
      /*
       * âœ¨ ê°œì„ ëœ ì ‘ê·¼: HTML ì†ì„± ë³´í˜¸í•˜ë©° ë‹¨ê³„ë³„ ì•ˆì „í•œ ì²˜ë¦¬
       */
      const clozeContent = this.dataset.cloze;
      console.log("ì›ë³¸ ë‚´ìš©:", clozeContent);
      
      let result = clozeContent;
      
      // 1ë‹¨ê³„: HTML íƒœê·¸ì™€ ì†ì„±ì„ ë³´í˜¸
      const htmlElements = [];
      let htmlElementIndex = 0;
      
      result = result.replace(/<[^>]+>/g, function(match) {
        const placeholder = `__CALLBACK_HTML_${htmlElementIndex}__`;
        htmlElements.push(match);
        console.log(`ì½œë°± HTML ìš”ì†Œ ë³´í˜¸ #${htmlElementIndex}:`, match);
        htmlElementIndex++;
        return placeholder;
      });
      
      // 2ë‹¨ê³„: ë³´í˜¸ëœ ìƒíƒœì—ì„œ ë°±í‹± ì²˜ë¦¬
      // íŒ¨í„´ 1: <`ë‚´ìš©`> í˜•íƒœ (Ankiê°€ ë°±í‹±ì„ íŒŒì‹±í•œ í›„)
      result = result.replace(/<`([^`]+)`>/g, function(match, code) {
        console.log("ì½œë°± - íŒ¨í„´ 1 ë§¤ì¹­:", match, "â†’", code);
        const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<code>${escapedCode}</code>`;
      });
      
      // íŒ¨í„´ 2: ì¼ë°˜ì ì¸ ë°±í‹± `ë‚´ìš©` 
      result = result.replace(/`([^`]+)`/g, function(match, code) {
        console.log("ì½œë°± - íŒ¨í„´ 2 ë§¤ì¹­:", match, "â†’", code);
        const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<code>${escapedCode}</code>`;
      });
      
      // 3ë‹¨ê³„: HTML ìš”ì†Œ ë³µì›
      htmlElements.forEach((htmlElement, elementIndex) => {
        const placeholder = `__CALLBACK_HTML_${elementIndex}__`;
        result = result.replace(placeholder, htmlElement);
        console.log(`ì½œë°± HTML ìš”ì†Œ ë³µì› #${elementIndex}:`, htmlElement);
      });
      
      // 4ë‹¨ê³„: ë‚¨ì€ HTML íƒœê·¸ë“¤ ì´ìŠ¤ì¼€ì´í”„ (ë§í¬ì™€ ë§ˆí¬ë‹¤ìš´ í—ˆìš© íƒœê·¸ëŠ” ì œì™¸)
      // í—ˆìš©í•  ë§ˆí¬ë‹¤ìš´ HTML íƒœê·¸ë“¤: code, sup, sub, u, strong, em, b, i, mark, a (ë§í¬ ì¶”ê°€)
      result = result.replace(/<(?!\/?(code|sup|sub|u|strong|em|b|i|mark|a)\b)[^>]*>/g, function(match) {
        console.log("ì½œë°± - íŒ¨í„´ 3 ë§¤ì¹­ (HTML ì´ìŠ¤ì¼€ì´í”„):", match);
        return match.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      });
      
      console.log("ì²˜ë¦¬ í›„ ë‚´ìš©:", result);
      this.innerHTML = result;
      
      // ì‹œê°ì  ìŠ¤íƒ€ì¼ ë³€ê²½: ë°°ê²½ìƒ‰ ì œê±°, ë°‘ì¤„ í‘œì‹œ
      this.style.backgroundColor = "transparent";
      this.style.boxShadow = "inset 0 -2px 0 #85B0FD";
      
    } else {
      /*
       * ğŸ“– cloze ì ‘ê¸° (í¼ì³ì§„ ìƒíƒœ â†’ ì ‘íŒ ìƒíƒœ)
       */
      console.log("cloze ì ‘ê¸°");
      
      // ì„ì‹œ ì €ì¥ëœ ordinal ê°’ ë³µì›
      this.dataset.ordinal = this.dataset.tempOrdinal;
      
      // ì‹œê°ì  ìŠ¤íƒ€ì¼ ë³€ê²½: ë°°ê²½ìƒ‰ ë³µì›
      this.style.backgroundColor = "#85B0FD";
      
      // ì›ë˜ ì ‘íŒ ìƒíƒœë¡œ ë³µì› (HTML í¬í•¨)
      if (this.dataset.hint === "false") {
        this.textContent = "[___]";
      } else {
        // hintëŠ” HTMLì„ í¬í•¨í•œ ì›ë˜ ìƒíƒœì´ë¯€ë¡œ innerHTMLë¡œ ë³µì›
        this.innerHTML = this.dataset.hint;
      }
      console.log("ì ‘ì€ í›„ ë‚´ìš©:", this.textContent);
    }
    
    // ë§í¬ ë Œë”ë§ ì¬ì ìš©
    renderLink();
    console.log("========= ê°œì„ ëœ Callback í•¨ìˆ˜ ì¢…ë£Œ =========");
  }

  /*
   * âŒ¨ï¸ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜ (ë§í¬ ë³´í˜¸ ê°œì„ )
   * 
   * ê¸°ëŠ¥: "J" í‚¤(ë˜ëŠ” í•œê¸€ "ã…“")ë¥¼ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ì ‘íŒ clozeë¥¼ í¼ì¹¨
   * 
   * ë™ì‘ ì›ë¦¬:
   * 1. ëª¨ë“  cloze ì¤‘ì—ì„œ ordinal !== "0"ì¸ ì²« ë²ˆì§¸ ìš”ì†Œ ì°¾ê¸°
   * 2. í•´ë‹¹ ìš”ì†Œì— ëŒ€í•´ callbackê³¼ ë™ì¼í•œ ë¡œì§ ì ìš© (ë§í¬ ë³´í˜¸ í¬í•¨)
   * 3. ì½”ë“œ ë¸”ë¡ ë‚´ë¶€/ì™¸ë¶€ êµ¬ë¶„í•˜ì—¬ ë‹¤ë¥´ê²Œ ì²˜ë¦¬
   */
  function handleKeydown(event) {
    if (event.key === "j" || event.key === "J" || event.key === "ã…“") {
      const clozeCards = document.querySelectorAll(".cloze");
      let firstClozeCard = null;

      // ì ‘íŒ ìƒíƒœì˜ ì²« ë²ˆì§¸ cloze ì°¾ê¸°
      for (let clozeCard of clozeCards) {
        if (clozeCard.dataset.ordinal !== "0") {
          firstClozeCard = clozeCard;
          break;
        }
      }

      function callback() {
        // ì´ë¯¸ í¼ì³ì§„ ìƒíƒœë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
        if (firstClozeCard.dataset.ordinal === "0") return;

        console.log("í‚¤ë³´ë“œ - ë§í¬ ë³´í˜¸ ì²˜ë¦¬");

        // ìƒíƒœ ì „í™˜ ì²˜ë¦¬
        firstClozeCard.dataset.tempOrdinal = firstClozeCard.dataset.ordinal;
        firstClozeCard.dataset.ordinal = "0";
        
        // hintê°€ ì—†ì„ ë•Œë§Œ ìµœì´ˆ í•œ ë²ˆ ì €ì¥ (í‚¤ë³´ë“œ - HTML ë³´ì¡´)
        if (!firstClozeCard.dataset.hint) {
          firstClozeCard.dataset.hint = firstClozeCard.textContent === "[___]" ? "false" : firstClozeCard.innerHTML;
        }
        
        /*
         * âœ¨ í‚¤ë³´ë“œ - HTML ì†ì„± ë³´í˜¸í•˜ë©° ë‹¨ê³„ë³„ ì•ˆì „í•œ ì²˜ë¦¬
         */
        const clozeContent = firstClozeCard.dataset.cloze;
        console.log("í‚¤ë³´ë“œ - ì›ë³¸ ë‚´ìš©:", clozeContent);
        
        let result = clozeContent;
        
        // 1ë‹¨ê³„: HTML íƒœê·¸ì™€ ì†ì„±ì„ ë³´í˜¸
        const htmlElements = [];
        let htmlElementIndex = 0;
        
        result = result.replace(/<[^>]+>/g, function(match) {
          const placeholder = `__KEYBOARD_HTML_${htmlElementIndex}__`;
          htmlElements.push(match);
          console.log(`í‚¤ë³´ë“œ HTML ìš”ì†Œ ë³´í˜¸ #${htmlElementIndex}:`, match);
          htmlElementIndex++;
          return placeholder;
        });
        
        // 2ë‹¨ê³„: ë³´í˜¸ëœ ìƒíƒœì—ì„œ ë°±í‹± ì²˜ë¦¬
        // íŒ¨í„´ 1: <`ë‚´ìš©`> í˜•íƒœ (Ankiê°€ ë°±í‹±ì„ íŒŒì‹±í•œ í›„)
        result = result.replace(/<`([^`]+)`>/g, function(match, code) {
          console.log("í‚¤ë³´ë“œ - íŒ¨í„´ 1 ë§¤ì¹­:", match, "â†’", code);
          const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `<code>${escapedCode}</code>`;
        });
        
        // íŒ¨í„´ 2: ì¼ë°˜ì ì¸ ë°±í‹± `ë‚´ìš©` 
        result = result.replace(/`([^`]+)`/g, function(match, code) {
          console.log("í‚¤ë³´ë“œ - íŒ¨í„´ 2 ë§¤ì¹­:", match, "â†’", code);
          const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `<code>${escapedCode}</code>`;
        });
        
        // 3ë‹¨ê³„: HTML ìš”ì†Œ ë³µì›
        htmlElements.forEach((htmlElement, elementIndex) => {
          const placeholder = `__KEYBOARD_HTML_${elementIndex}__`;
          result = result.replace(placeholder, htmlElement);
          console.log(`í‚¤ë³´ë“œ HTML ìš”ì†Œ ë³µì› #${elementIndex}:`, htmlElement);
        });
        
        // 4ë‹¨ê³„: ë‚¨ì€ HTML íƒœê·¸ë“¤ ì´ìŠ¤ì¼€ì´í”„ (ë§í¬ì™€ ë§ˆí¬ë‹¤ìš´ í—ˆìš© íƒœê·¸ëŠ” ì œì™¸)
        // í—ˆìš©í•  ë§ˆí¬ë‹¤ìš´ HTML íƒœê·¸ë“¤: code, sup, sub, u, strong, em, b, i, mark, a (ë§í¬ ì¶”ê°€)
        result = result.replace(/<(?!\/?(code|sup|sub|u|strong|em|b|i|mark|a)\b)[^>]*>/g, function(match) {
          console.log("í‚¤ë³´ë“œ - íŒ¨í„´ 3 ë§¤ì¹­ (HTML ì´ìŠ¤ì¼€ì´í”„):", match);
          return match.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        });
        
        console.log("í‚¤ë³´ë“œ - ì²˜ë¦¬ í›„ ë‚´ìš©:", result);
        firstClozeCard.innerHTML = result;
        
        // ì‹œê°ì  ìŠ¤íƒ€ì¼ ë³€ê²½
        firstClozeCard.style.backgroundColor = "transparent";
        firstClozeCard.style.boxShadow = "inset 0 -2px 0 #85B0FD";
      }

      callback();
      // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ì—ì„œë„ ë§í¬ ë Œë”ë§ ì ìš©
      renderLink();
    }
  }

  function show() {
    document.getElementById("front").style.visibility = "visible";
  }

  function renderMath(ID) {
    const element = document.getElementById(ID);
    let text = element.innerHTML;
    text = replaceInString(text);
    element.textContent = text;
    renderMathInElement(element, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ],
      throwOnError: false,
    });
  }

  function markdown(ID) {
    console.log("========= Markdown í•¨ìˆ˜ ì‹œì‘ =========");
    const md = getMarkdownRenderer();
    const element = document.getElementById(ID);
    let text = replaceHTMLElementsInString(element.innerHTML);
    console.log("ì´ˆê¸° í…ìŠ¤íŠ¸:", text);
    
    /*
     * ğŸ¯ STEP 0: ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì´ì „ ë°±í‹± ë³´í˜¸ (ìƒˆë¡œìš´ ì ‘ê·¼ë²•)
     * 
     * ë°±í‹±ì„ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜í•˜ì—¬ markdown-itì´ ê±´ë“œë¦¬ì§€ ëª»í•˜ê²Œ í•¨
     */
    text = protectBackticks(text);
    console.log("ë°±í‹± ë³´í˜¸ ì™„ë£Œ:", text);
    
    /*
     * ğŸ¯ STEP 1: ì½”ë“œ ë¸”ë¡ ë‚´ cloze span ì„ì‹œ ì €ì¥ (ë‹¨ìˆœ ì ‘ê·¼)
     * 
     * ë„ˆë¬´ ë³µì¡í•˜ê²Œ ëª¨ë“  clozeë¥¼ ë³´í˜¸í•˜ì§€ ë§ê³ , 
     * ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ì˜ clozeë§Œ ë³´í˜¸í•˜ëŠ” ê¸°ë³¸ ë°©ì‹ìœ¼ë¡œ ë³µê·€
     */
    const clozeSpans = [];
    let codeBlockCount = 0;
    
    // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ íŒ¨í„´ ë§¤ì¹­: ```[ì–¸ì–´ëª…] ... ```
    text = text.replace(/(```[a-zA-Z0-9_\-]+[\s\S]*?```)/g, function(codeBlock) {
      console.log(`ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ #${++codeBlockCount} ë°œê²¬:`, codeBlock);
      
      // í•´ë‹¹ ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ì˜ cloze spanì„ ì°¾ì•„ì„œ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ êµì²´
      return codeBlock.replace(/<span\s+class\s*=\s*["']cloze["'][^>]*>.*?<\/span>/gi, function(match) {
        const placeholder = `__CLOZE_SPAN_${clozeSpans.length}__`;
        clozeSpans.push(match);
        console.log(`ì½”ë“œ ë¸”ë¡ ë‚´ cloze ìŠ¤íŒ¬ #${clozeSpans.length} ë°œê²¬:`, match, `=> í”Œë ˆì´ìŠ¤í™€ë”:`, placeholder);
        return placeholder;
      });
    });
    
    console.log("cloze ìŠ¤íŒ¬ êµì²´ í›„ í…ìŠ¤íŠ¸:", text);
    console.log("ì €ì¥ëœ cloze ìŠ¤íŒ¬:", clozeSpans);
    
    /*
     * ğŸ¯ STEP 2: ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ìˆ˜í–‰
     */
    text = md.render(text);
    console.log("ë§ˆí¬ë‹¤ìš´ ë³€í™˜ í›„ í…ìŠ¤íŠ¸:", text);
    
    /*
     * ğŸ¯ STEP 3: ì¼ë°˜ span íƒœê·¸ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
     */
    text = text.replace(/&lt;\/span&gt;/gi, "\\");
    console.log("span íƒœê·¸ ì´ìŠ¤ì¼€ì´í”„ í›„ í…ìŠ¤íŠ¸:", text);
    
    /*
     * ğŸ¯ STEP 4: ì €ì¥ëœ cloze span ë³µì›
     */
    let finalText = text;
    clozeSpans.forEach((span, index) => {
      const placeholder = `__CLOZE_SPAN_${index}__`;
      
      const placeholderPattern = new RegExp(placeholder, 'g');
      if(finalText.match(placeholderPattern)) {
        console.log(`cloze ìŠ¤íŒ¬ #${index} ë³µì›:`, span);
        finalText = finalText.replace(placeholderPattern, span);
      } else {
        console.log(`cloze ìŠ¤íŒ¬ #${index} ë³µì› ì‹¤íŒ¨, íŒ¨í„´ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`, span);
      }
    });
    
    console.log("ìµœì¢… ì¶œë ¥:", finalText);
    
          /*
       * ğŸ¯ STEP 5: DOMì— ì„¤ì •
       */
      element.innerHTML = finalText;
      
      /*
       * ğŸ¯ STEP 5.5: ë³´í˜¸ëœ ë°±í‹± ì½”ë“œë¥¼ <code> íƒœê·¸ë¡œ ë³€í™˜
       * 
       * HTML ì—”í‹°í‹°ë¡œ ë³´í˜¸ëœ ë°±í‹±ì„ ì°¾ì•„ì„œ <code> íƒœê·¸ë¡œ ë³€í™˜
       */
      processProtectedBackticks(element);
      
      /*
       * ğŸ¯ STEP 6: ì´ˆê¸° ë°±í‹± â†’ ì½”ë“œ íƒœê·¸ ë³€í™˜ (ëª¨ë“  clozeì— ì ìš©)
     */
    convertBackticksToCodeTags(element);
    
    /*
     * ğŸ¯ STEP 7: ë‹¨ìˆœí•œ HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
     * 
     * DOM ìƒì„± í›„ íŠ¹ì • HTML íƒœê·¸ë§Œ ì„ ë³„ì ìœ¼ë¡œ ì´ìŠ¤ì¼€ì´í”„
     */
    escapeSpecificHtmlTags(element);
    
    console.log("========= Markdown í•¨ìˆ˜ ì¢…ë£Œ =========");
  }

  /*
   * ğŸ¯ ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì´ì „ ë°±í‹± ë³´í˜¸ í•¨ìˆ˜ (ê°œì„ ëœ ì ‘ê·¼ë²•)
   * 
   * ëª©ì : ë°±í‹±ì„ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜í•˜ë˜, HTML ì†ì„± ë‚´ë¶€ëŠ” ë³´í˜¸
   * ì¤‘ìš”: ì½”ë“œ ë¸”ë¡(```...```) ë‚´ë¶€ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
   */
  function protectBackticks(text) {
    console.log("===== ë°±í‹± ë³´í˜¸ ì‹œì‘ =====");
    console.log("ì›ë³¸ í…ìŠ¤íŠ¸:", text);
    
    // 1ë‹¨ê³„: ì½”ë“œ ë¸”ë¡ ì˜ì—­ì„ ë¨¼ì € ì°¾ì•„ì„œ ë³´í˜¸
    const codeBlocks = [];
    let codeBlockIndex = 0;
    
    // ì½”ë“œ ë¸”ë¡ íŒ¨í„´ì„ ì„ì‹œ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ êµì²´
    let textWithProtectedCodeBlocks = text.replace(/(```[\s\S]*?```)/g, function(match) {
      const placeholder = `__CODE_BLOCK_${codeBlockIndex}__`;
      codeBlocks.push(match);
      console.log(`ğŸ”’ ì½”ë“œ ë¸”ë¡ #${codeBlockIndex} ë³´í˜¸:`, match.substring(0, 50) + "...");
      codeBlockIndex++;
      return placeholder;
    });
    
    console.log(`ì´ ${codeBlocks.length}ê°œì˜ ì½”ë“œ ë¸”ë¡ ë³´í˜¸ë¨`);
    
    // 2ë‹¨ê³„: HTML íƒœê·¸ ì „ì²´ë¥¼ ë³´í˜¸
    const htmlTags = [];
    let htmlTagIndex = 0;
    
    // HTML íƒœê·¸ íŒ¨í„´ì„ ì„ì‹œ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ êµì²´ (ì†ì„± í¬í•¨)
    let textWithProtectedTags = textWithProtectedCodeBlocks.replace(/<[^>]+>/g, function(match) {
      const placeholder = `__HTML_TAG_${htmlTagIndex}__`;
      htmlTags.push(match);
      console.log(`ğŸ”’ HTML íƒœê·¸ #${htmlTagIndex} ë³´í˜¸:`, match);
      htmlTagIndex++;
      return placeholder;
    });
    
    console.log(`ì´ ${htmlTags.length}ê°œì˜ HTML íƒœê·¸ ë³´í˜¸ë¨`);
    
    // 3ë‹¨ê³„: ë‚¨ì€ ë°±í‹±ì„ ìœ ë‹ˆì½”ë“œ ë¬¸ìë¡œ ë³€í™˜
    let processedText = textWithProtectedTags.replace(/`([^`]+)`/g, function(match, code) {
      console.log(`ğŸ” ë°±í‹± ì½”ë“œ ë°œê²¬: ${match}`);
      // ë°±í‹±ì„ íŠ¹ìˆ˜ ìœ ë‹ˆì½”ë“œ ë¬¸ìë¡œ ì¹˜í™˜
      return `â€¹${code}â€º`;
    });
    
    // 4ë‹¨ê³„: HTML íƒœê·¸ ë³µì›
    htmlTags.forEach((htmlTag, index) => {
      const placeholder = `__HTML_TAG_${index}__`;
      processedText = processedText.replace(placeholder, htmlTag);
      console.log(`ğŸ”“ HTML íƒœê·¸ #${index} ë³µì› ì™„ë£Œ`);
    });
    
    // 5ë‹¨ê³„: ì½”ë“œ ë¸”ë¡ ë³µì›
    codeBlocks.forEach((codeBlock, index) => {
      const placeholder = `__CODE_BLOCK_${index}__`;
      processedText = processedText.replace(placeholder, codeBlock);
      console.log(`ğŸ”“ ì½”ë“œ ë¸”ë¡ #${index} ë³µì› ì™„ë£Œ`);
    });
    
    console.log("ë°±í‹± ë³´í˜¸ í›„:", processedText);
    console.log("===== ë°±í‹± ë³´í˜¸ ì¢…ë£Œ =====");
    return processedText;
  }

  /*
   * ğŸ¯ ë³´í˜¸ëœ ë°±í‹± ì½”ë“œë¥¼ <code> íƒœê·¸ë¡œ ë³€í™˜
   * 
   * ëª©ì : ìœ ë‹ˆì½”ë“œ ë¬¸ìë¡œ ë³´í˜¸ëœ ë°±í‹±ì„ ì°¾ì•„ì„œ <code> íƒœê·¸ë¡œ ë³€í™˜
   */
  function processProtectedBackticks(container) {
    console.log("===== ë³´í˜¸ëœ ë°±í‹± ì²˜ë¦¬ ì‹œì‘ =====");
    
    // í˜„ì¬ HTML í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    let htmlContent = container.innerHTML;
    console.log("ì²˜ë¦¬ ì „ HTML:", htmlContent);
    
    // ìœ ë‹ˆì½”ë“œ ë¬¸ìë¡œ ë³´í˜¸ëœ ë°±í‹±ì„ <code> íƒœê·¸ë¡œ ë³€í™˜
    let processedCount = 0;
    htmlContent = htmlContent.replace(/â€¹([^â€º]+)â€º/g, function(match, code) {
      console.log(`ğŸ” ë³´í˜¸ëœ ë°±í‹± ë°œê²¬: ${match}`);
      
      // HTML íƒœê·¸ ì´ìŠ¤ì¼€ì´í”„
      const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const codeTag = `<code>${escapedCode}</code>`;
      
      console.log(`  ë³€í™˜: ${match} â†’ ${codeTag}`);
      processedCount++;
      
      return codeTag;
    });
    
    // ìˆ˜ì •ëœ HTMLì„ ë‹¤ì‹œ ì„¤ì •
    container.innerHTML = htmlContent;
    console.log(`ì²˜ë¦¬ ì™„ë£Œ: ${processedCount}ê°œì˜ ë°±í‹± ì½”ë“œ ë³€í™˜`);
    console.log("ì²˜ë¦¬ í›„ HTML:", htmlContent);
    
    console.log("===== ë³´í˜¸ëœ ë°±í‹± ì²˜ë¦¬ ì¢…ë£Œ =====");
  }

  /*
   * ğŸ¨ ì´ˆê¸° ë°±í‹± â†’ ì½”ë“œ íƒœê·¸ ë³€í™˜ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
   * 
   * ëª©ì : í˜ì´ì§€ ë¡œë”© ì‹œ ëª¨ë“  clozeì˜ ë°±í‹±ì„ <code> íƒœê·¸ë¡œ ë³€í™˜
   * ì¤‘ìš”: HTML ì†ì„± ë‚´ë¶€ì˜ ë°±í‹±ì€ ë³´í˜¸
   */
  function convertBackticksToCodeTags(container) {
    console.log("===== ì´ˆê¸° ë°±í‹± â†’ ì½”ë“œ íƒœê·¸ ë³€í™˜ ì‹œì‘ =====");
    
    // ëª¨ë“  cloze span ì°¾ê¸°
    const allClozeSpans = container.querySelectorAll('span.cloze');
    console.log(`ë°±í‹± ë³€í™˜ ëŒ€ìƒ: ${allClozeSpans.length}ê°œì˜ cloze span`);
    
    allClozeSpans.forEach((span, index) => {
      console.log(`\n--- cloze span #${index + 1} ë°±í‹± ì²˜ë¦¬ ---`);
      
      const originalHtml = span.innerHTML;
      console.log("ì›ë³¸ ë‚´ìš©:", originalHtml);
      
      /*
       * HTML ì†ì„± ë³´í˜¸ ì²˜ë¦¬
       */
      let result = originalHtml;
      
      // 1ë‹¨ê³„: HTML íƒœê·¸ì™€ ì†ì„±ì„ ë³´í˜¸
      const htmlElements = [];
      let htmlElementIndex = 0;
      
      result = result.replace(/<[^>]+>/g, function(match) {
        const placeholder = `__HTML_ELEMENT_${htmlElementIndex}__`;
        htmlElements.push(match);
        console.log(`HTML ìš”ì†Œ ë³´í˜¸ #${htmlElementIndex}:`, match);
        htmlElementIndex++;
        return placeholder;
      });
      
      // 2ë‹¨ê³„: ë³´í˜¸ëœ ìƒíƒœì—ì„œ ë°±í‹± ì²˜ë¦¬
      // íŒ¨í„´ 1: <`ë‚´ìš©`> í˜•íƒœ (Ankiê°€ ë°±í‹±ì„ íŒŒì‹±í•œ í›„)
      result = result.replace(/<`([^`]+)`>/g, function(match, code) {
        console.log("ì´ˆê¸° - íŒ¨í„´ 1 ë§¤ì¹­:", match, "â†’", code);
        const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<code>${escapedCode}</code>`;
      });
      
      // íŒ¨í„´ 2: ì¼ë°˜ì ì¸ ë°±í‹± `ë‚´ìš©` 
      result = result.replace(/`([^`]+)`/g, function(match, code) {
        console.log("ì´ˆê¸° - íŒ¨í„´ 2 ë§¤ì¹­:", match, "â†’", code);
        const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<code>${escapedCode}</code>`;
      });
      
      // 3ë‹¨ê³„: HTML ìš”ì†Œ ë³µì›
      htmlElements.forEach((htmlElement, elementIndex) => {
        const placeholder = `__HTML_ELEMENT_${elementIndex}__`;
        result = result.replace(placeholder, htmlElement);
        console.log(`HTML ìš”ì†Œ ë³µì› #${elementIndex}:`, htmlElement);
      });
      
      // 4ë‹¨ê³„: ë‚¨ì€ HTML íƒœê·¸ë“¤ ì´ìŠ¤ì¼€ì´í”„ (ë§ˆí¬ë‹¤ìš´ í—ˆìš© íƒœê·¸ëŠ” ì œì™¸)
      // í—ˆìš©í•  ë§ˆí¬ë‹¤ìš´ HTML íƒœê·¸ë“¤: code, sup, sub, u, strong, em, b, i, mark, a (ë§í¬ ì¶”ê°€)
      result = result.replace(/<(?!\/?(code|sup|sub|u|strong|em|b|i|mark|a)\b)[^>]*>/g, function(match) {
        console.log("ì´ˆê¸° - íŒ¨í„´ 3 ë§¤ì¹­ (HTML ì´ìŠ¤ì¼€ì´í”„):", match);
        return match.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      });
      
      if (result !== originalHtml) {
        span.innerHTML = result;
        console.log("ì´ˆê¸° ë°±í‹± ë³€í™˜ ì™„ë£Œ:", result);
      } else {
        console.log("ë³€í™˜í•  ë°±í‹± ì—†ìŒ");
      }
    });
    
    console.log("===== ì´ˆê¸° ë°±í‹± â†’ ì½”ë“œ íƒœê·¸ ë³€í™˜ ì™„ë£Œ =====");
  }

  /*
   * ğŸ”§ ë‹¨ìˆœí•œ HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ í•¨ìˆ˜ (ë§í¬ ë³´í˜¸ ê°œì„ )
   * 
   * ëª©ì : cloze ë‚´ë¶€ì˜ íŠ¹ì • HTML íƒœê·¸ë§Œ ì„ ë³„ì ìœ¼ë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
   * ì¤‘ìš”: ë§í¬(a íƒœê·¸)ëŠ” ë³´í˜¸
   */
  function escapeSpecificHtmlTags(container) {
    console.log("===== ë§í¬ ë³´í˜¸ HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ ì‹œì‘ =====");
    
    // ì´ìŠ¤ì¼€ì´í”„í•  HTML íƒœê·¸ ëª©ë¡ (êµ¬ì¡°ì ì¸ íƒœê·¸ë“¤ë§Œ, ë§ˆí¬ë‹¤ìš´ í—ˆìš© íƒœê·¸ì™€ ë§í¬ëŠ” ì œì™¸)
    // í—ˆìš©ë˜ëŠ” ë§ˆí¬ë‹¤ìš´ HTML íƒœê·¸: code, sup, sub, u, strong, em, b, i, mark, a (ë§í¬ ì¶”ê°€)
    const tagsToEscape = ['form', 'input', 'button', 'div', 'span', 'tr', 'td', 'th', 
                          'ul', 'ol', 'li', 'select', 'option', 'textarea'];
    
    // ëª¨ë“  cloze span ì°¾ê¸°
    const allClozeSpans = container.querySelectorAll('span.cloze');
    console.log(`ì´ ${allClozeSpans.length}ê°œì˜ cloze span ë°œê²¬`);
    
    allClozeSpans.forEach((span, index) => {
      console.log(`\n--- cloze span #${index + 1} ì²˜ë¦¬ ---`);
      
      // í˜„ì¬ spanì´ ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ì— ìˆëŠ”ì§€ í™•ì¸
      let isInCodeBlock = false;
      let parent = span.parentElement;
      
      while (parent) {
        if (parent.nodeName === "CODE") {
          isInCodeBlock = true;
          break;
        }
        parent = parent.parentElement;
      }
      
      const originalHtml = span.innerHTML;
      console.log("ì›ë³¸ ë‚´ìš©:", originalHtml);
      console.log("ì½”ë“œ ë¸”ë¡ ë‚´ë¶€?", isInCodeBlock);
      
      if (isInCodeBlock) {
        /*
         * ì½”ë“œ ë¸”ë¡ ë‚´ë¶€: ëª¨ë“  HTMLì„ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
         */
        if (originalHtml && !originalHtml.includes('&lt;')) {
          span.textContent = originalHtml;
          console.log("ì½”ë“œ ë¸”ë¡ì—ì„œ ì „ì²´ ì´ìŠ¤ì¼€ì´í”„:", span.innerHTML);
        }
      } else {
        /*
         * ì¼ë°˜ ì˜ì—­: íŠ¹ì • HTML íƒœê·¸ë§Œ ì´ìŠ¤ì¼€ì´í”„ (ë§í¬ëŠ” ë³´í˜¸)
         */
        let content = originalHtml;
        let hasChanges = false;
        
        // ê° íƒœê·¸ì— ëŒ€í•´ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
        tagsToEscape.forEach(tag => {
          // <tag> í˜•íƒœì˜ ì—´ë¦° íƒœê·¸
          const openTagRegex = new RegExp(`<${tag}\\b[^>]*>`, 'gi');
          if (content.match(openTagRegex)) {
            content = content.replace(openTagRegex, function(match) {
              hasChanges = true;
              return match.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            });
          }
          
          // </tag> í˜•íƒœì˜ ë‹«íŒ íƒœê·¸
          const closeTagRegex = new RegExp(`</${tag}>`, 'gi');
          if (content.match(closeTagRegex)) {
            content = content.replace(closeTagRegex, function(match) {
              hasChanges = true;
              return match.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            });
          }
        });
        
        if (hasChanges) {
          span.innerHTML = content;
          console.log("ì¼ë°˜ ì˜ì—­ì—ì„œ ì„ ë³„ì  ì´ìŠ¤ì¼€ì´í”„:", content);
        } else {
          console.log("ì´ìŠ¤ì¼€ì´í”„í•  íƒœê·¸ ì—†ìŒ");
        }
      }
    });
    
    console.log("===== ë§í¬ ë³´í˜¸ HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ ì™„ë£Œ =====");
  }

  function replaceInString(str) {
    str = str.replace(/<[\/]?pre[^>]*>/gi, "");
    str = str.replace(/<br\s*[\/]?[^>]*>/gi, "\n");
    str = str.replace(/<div[^>]*>/gi, "\n");
    str.replace(/<\/div[^>]*>/g, "\n");
    return replaceHTMLElementsInString(str);
  }

  function replaceHTMLElementsInString(str) {
    str = str.replace(/&nbsp;/gi, " ");
    str = str.replace(/&tab;/gi, "	");
    str = str.replace(/&gt;/gi, ">");
    str = str.replace(/&lt;/gi, "<");
    return str.replace(/&amp;/gi, "&");
  }
</script>

<script>
  // Anki Note Linkerë¥¼ Mobile í™˜ê²½ì—ì„œë„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ fallback ì½”ë“œ
  var disableLinks = false; // Change to true if you want to disable all link rendering for clients without add-on
  if (!window.AnkiNoteLinkerIsActive) {
    const renderLinks = (_) => {
      document.querySelectorAll(".linkRender").forEach((element) => {
        // You can rename "linkRender" on this line, but leave the "." in front
        element.innerHTML = element.innerHTML.replace(
          /\[((?:[^\[]|\\\[)*)\|nid(\d{13})\]/g,
          (match, title, nid) => {
            title = title.replace(/\\\[/g, "[");
            let link;
            if (
              document.documentElement.classList.contains("iphone") ||
              document.documentElement.classList.contains("ipad")
            ) {
              link = `anki://x-callback-url/search?query=nid%3a${nid}`;
            } else
              try {
                window.jsAPI ||= new AnkiDroidJS({
                  version: "0.0.3",
                  developer: "github.com/gugutu",
                });
                link = `javascript:window.jsAPI.ankiSearchCard(\`nid:${nid}\`)`;
              } catch (e) {
                link = `https://ankiuser.net/edit/${nid}' target='_blank`;
              }
            return disableLinks
              ? `${title}`
              : `<a href='${link}' class='noteLink'>${title}</a>`;
          }
        );
      });
    };
    document.readyState !== "loading"
      ? renderLinks()
      : document.addEventListener("DOMContentLoaded", renderLinks, {
          once: true,
        });
  }
</script>

<!-- 
ğŸ¯ ANKI CLOZE + MARKDOWN + ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬ í”Œë¡œìš° ìƒì„¸ ì„¤ëª…

=== ğŸ“‹ ì „ì²´ ê°œìš” ===
ì´ ì¹´ë“œ í…œí”Œë¦¿ì€ Anki cloze ê¸°ëŠ¥ê³¼ ë§ˆí¬ë‹¤ìš´ íŒŒì‹±ì„ ê²°í•©í•˜ë˜,
ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ì˜ HTML íƒœê·¸ëŠ” ì‹¤ì œ DOM ìš”ì†Œê°€ ì•„ë‹Œ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œí•˜ëŠ” íŠ¹ë³„í•œ ì²˜ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

=== ğŸ”„ ì£¼ìš” ì²˜ë¦¬ í”Œë¡œìš° ===

1ï¸âƒ£ ì´ˆê¸°í™” (render í•¨ìˆ˜)
   â”œâ”€ defineEnhancedClozeAddEventListener() : ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
   â”œâ”€ renderMath("front") : KaTeX ìˆ˜í•™ ê³µì‹ ë Œë”ë§
   â”œâ”€ markdown("front") : ë§ˆí¬ë‹¤ìš´ + cloze ì²˜ë¦¬ (í•µì‹¬ ë¡œì§)
   â”œâ”€ show() : ì¹´ë“œ í‘œì‹œ
   â””â”€ cloze ì´ë²¤íŠ¸ ë°”ì¸ë”© : í´ë¦­/í„°ì¹˜/í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì—°ê²°

2ï¸âƒ£ ë§ˆí¬ë‹¤ìš´ ì²˜ë¦¬ (markdown í•¨ìˆ˜) â˜… í•µì‹¬ â˜…
   â”œâ”€ STEP 0: ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì´ì „ ë°±í‹± ì½”ë“œ ì „ì²˜ë¦¬ â˜… ì¬í™œì„±í™” (ì•ˆì „í•œ í”Œë ˆì´ìŠ¤í™€ë”) â˜…
   â”‚   â”œâ”€ [PROTECTED_CODE_n] í˜•íƒœë¡œ Anki í•„ë“œ ë¬¸ë²•ê³¼ markdown-itì˜ ë³¼ë“œ í•´ì„ ëª¨ë‘ ë°©ì§€
   â”‚   â”œâ”€ ì½”ë“œ ë¸”ë¡(```...```) ë‚´ë¶€ëŠ” ì œì™¸í•˜ì—¬ ê¸°ì¡´ íŒŒì‹± ë¡œì§ ë³´í˜¸
   â”‚   â””â”€ í…Œì´ë¸” ë° ì¼ë°˜ ì˜ì—­ì˜ ë°±í‹±ë§Œ ë³´í˜¸í•˜ì—¬ ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì‹œ êµ¬ì¡° ê¹¨ì§ ë°©ì§€
   â”‚
   â”œâ”€ STEP 1: ì½”ë“œ ë¸”ë¡ ë‚´ cloze span ì„ì‹œ ì €ì¥
   â”‚   â”œâ”€ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ íŒ¨í„´ íƒì§€ : /(```[a-zA-Z0-9_\-]+[\s\S]*?```)/g
   â”‚   â”œâ”€ ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ì˜ <span class="cloze">...</span> ì¶”ì¶œ
   â”‚   â””â”€ í”Œë ˆì´ìŠ¤í™€ë”(__CLOZE_SPAN_X__)ë¡œ ì„ì‹œ êµì²´
   â”‚
   â”œâ”€ STEP 2: ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ìˆ˜í–‰
   â”‚   â””â”€ markdown-it ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë§ˆí¬ë‹¤ìš´ â†’ HTML ë³€í™˜
   â”‚
   â”œâ”€ STEP 3: ì¼ë°˜ span íƒœê·¸ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
   â”‚   â””â”€ &lt;/span&gt; â†’ \ êµì²´
   â”‚
   â”œâ”€ STEP 4: ì €ì¥ëœ cloze span ë³µì›
   â”‚   â””â”€ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì›ë˜ cloze spanìœ¼ë¡œ êµì²´ (ì´ìŠ¤ì¼€ì´í”„ ì—†ì´)
   â”‚
   â”œâ”€ STEP 5: DOMì— ì„¤ì •
   â”‚   â””â”€ element.innerHTML = finalText
   â”‚
   â”œâ”€ STEP 5.5: ë³´í˜¸ëœ ë°±í‹± ì½”ë“œë¥¼ <code> íƒœê·¸ë¡œ ë³€í™˜
   â”‚   â””â”€ ì „ì²˜ë¦¬ë¡œ ë³´í˜¸ëœ ëª¨ë“  ë°±í‹±ì„ ì•ˆì „í•˜ê²Œ ë³µì›
   â”‚
   â”œâ”€ STEP 6: ì´ˆê¸° ë°±í‹± â†’ ì½”ë“œ íƒœê·¸ ë³€í™˜ (ëª¨ë“  clozeì— ì ìš©)
   â”‚   â””â”€ convertBackticksToCodeTags() í˜¸ì¶œ
   â”‚
   â””â”€ STEP 7: ë‹¨ìˆœí•œ HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
       â””â”€ escapeSpecificHtmlTags() í˜¸ì¶œ

3ï¸âƒ£ ì½”ë“œ ë¸”ë¡ HTML ì´ìŠ¤ì¼€ì´í”„ (escapeHtmlInCodeBlocks í•¨ìˆ˜)
   â”œâ”€ code[class*="language-"] ìš”ì†Œë“¤ íƒìƒ‰
   â”œâ”€ ê° ì½”ë“œ ë¸”ë¡ ë‚´ì˜ span.cloze ìš”ì†Œë“¤ ì°¾ê¸°
   â”œâ”€ ì´ë¯¸ ì´ìŠ¤ì¼€ì´í”„ëœ ë‚´ìš©ì¸ì§€ í™•ì¸ (&lt;, &gt; í¬í•¨ ì—¬ë¶€)
   â””â”€ span.textContent = originalHtml (ë¸Œë¼ìš°ì € ìë™ ì´ìŠ¤ì¼€ì´í”„)

4ï¸âƒ£ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì²˜ë¦¬
   â”œâ”€ í´ë¦­ ì´ë²¤íŠ¸ (callback í•¨ìˆ˜)
   â”‚   â”œâ”€ ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ ìœ„ì¹˜ í™•ì¸
   â”‚   â”œâ”€ cloze ìƒíƒœ ì „í™˜ (ì ‘ê¸°/í¼ì¹˜ê¸°)
   â”‚   â”œâ”€ ì½”ë“œ ë¸”ë¡ ë‚´ë¶€: textContentë¡œ í…ìŠ¤íŠ¸ í‘œì‹œ
   â”‚   â””â”€ ì¼ë°˜ ì˜ì—­: innerHTML + ë§ˆí¬ë‹¤ìš´ íŒŒì‹±
   â”‚
   â””â”€ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (handleKeydown í•¨ìˆ˜)
       â””â”€ "J" í‚¤ë¡œ ì²« ë²ˆì§¸ ì ‘íŒ cloze í¼ì¹˜ê¸° (í´ë¦­ê³¼ ë™ì¼ ë¡œì§)

=== ğŸ¯ í•µì‹¬ ê¸°ìˆ ì  í•´ê²°ì±… ===

â“ ë¬¸ì œ: ë§ˆí¬ë‹¤ìš´ íŒŒì„œê°€ ì½”ë“œ ë¸”ë¡ ë‚´ cloze spanì„ ê¹¨ëœ¨ë¦¼
âœ… í•´ê²°: í”Œë ˆì´ìŠ¤í™€ë” íŒ¨í„´ìœ¼ë¡œ ì„ì‹œ ë³´í˜¸ í›„ ë³µì›

â“ ë¬¸ì œ: ì½”ë“œ ë¸”ë¡ ë‚´ HTML íƒœê·¸ê°€ ì‹¤ì œ DOMìœ¼ë¡œ ë Œë”ë§ë¨
âœ… í•´ê²°: textContent ì„¤ì •ìœ¼ë¡œ ë¸Œë¼ìš°ì € ìë™ ì´ìŠ¤ì¼€ì´í”„ í™œìš©

â“ ë¬¸ì œ: data-cloze, data-hint ì†ì„±ì´ ì´ì¤‘ ì´ìŠ¤ì¼€ì´í”„ë¨
âœ… í•´ê²°: innerHTMLì´ ì•„ë‹Œ í™”ë©´ í‘œì‹œ ë‚´ìš©ë§Œ ì´ìŠ¤ì¼€ì´í”„

â“ ë¬¸ì œ: í‚¤ë³´ë“œ "J" í‚¤ê°€ ì½”ë“œ ë¸”ë¡ì—ì„œ ë‹¤ë¥´ê²Œ ë™ì‘
âœ… í•´ê²°: í‚¤ë³´ë“œ ì´ë²¤íŠ¸ì—ë„ ë™ì¼í•œ ì½”ë“œ ë¸”ë¡ ê°ì§€ ë¡œì§ ì ìš©

â“ ë¬¸ì œ: __PROTECTED_CODE_n__ í”Œë ˆì´ìŠ¤í™€ë”ê°€ markdown-itì— ì˜í•´ **ë³¼ë“œ ë¬¸ë²•**ìœ¼ë¡œ í•´ì„ë¨
âœ… í•´ê²°: [PROTECTED_CODE_n] í˜•íƒœì˜ ì•ˆì „í•œ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ ë³€ê²½í•˜ì—¬ Anki í•„ë“œ ë¬¸ë²•ê³¼ ë§ˆí¬ë‹¤ìš´ íŒŒì„œì˜ ê°„ì„­ ëª¨ë‘ ë°©ì§€

=== ğŸ” ë””ë²„ê¹… ì •ë³´ ===
ì½˜ì†” ë¡œê·¸ë¥¼ í†µí•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
- ë§ˆí¬ë‹¤ìš´ í•¨ìˆ˜ ì‹œì‘/ì¢…ë£Œ
- ì´ˆê¸° í…ìŠ¤íŠ¸ ë‚´ìš©
- ë°œê²¬ëœ ì½”ë“œ ë¸”ë¡ ê°œìˆ˜ ë° ë‚´ìš©
- cloze ìŠ¤íŒ¬ ì¶”ì¶œ ë° ë³µì› ê³¼ì •
- ìµœì¢… HTML ì¶œë ¥
- í´ë¦­/í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ê³¼ì •
- ì½”ë“œ ë¸”ë¡ ë‚´ë¶€/ì™¸ë¶€ ìœ„ì¹˜ íŒë³„ ê²°ê³¼

=== ğŸ“š ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ===
- KaTeX: ìˆ˜í•™ ê³µì‹ ë Œë”ë§
- highlight.js: ì½”ë“œ êµ¬ë¬¸ ê°•ì¡°
- markdown-it: ë§ˆí¬ë‹¤ìš´ íŒŒì‹±
- markdown-it-mark: ==í…ìŠ¤íŠ¸== ë§ˆí¬ ì§€ì›
- markdown-it-container: ì»¤ìŠ¤í…€ ì»¨í…Œì´ë„ˆ ì§€ì› (tip, warning ë“±)

 -->